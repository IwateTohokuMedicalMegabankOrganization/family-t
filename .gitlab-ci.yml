stages:
  - test
  - review
  - analysis
  - deploy

# test
ut:
  stage: test
  script:
    - echo "do module test"

## review
deploy_for_review:
  stage: review
  tags: 
    - review_deploy
  script:
    - echo "update family-t mss demo server contents"
    - mkdir -p /var/www/html/$CI_COMMIT_REF_SLUG
    - cp -rf ./* /var/www/html/$CI_COMMIT_REF_SLUG/
    - echo "Deploy a review app"
  environment:
    name: review/$CI_COMMIT_REF_NAME
    url: http://family-t.tkb.mss.co.jp/$CI_COMMIT_REF_SLUG/
  only:
    - branches
  except:
    - master
    
# release
deploy:
  stage: deploy
  script:
    - echo "update family-t demo server contents"
  only:
    - develop

# SonarQube analysis
SonarQube:
  stage: analysis
  tags: 
    - shared
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_HOST_URL: http://sonarqube.tkb.mss.co.jp/
    SONAR_TOKEN: ${SONARQUBE_TOKEN}
    SONAR_PROJECT_BASE_DIR: ${CI_PROJECT_DIR}
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    SOURCE_ENCODING: UTF-8
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner -Dsonar.qualitygate.wait=true -Dsonar.projectKey=family-t -Dsonar.host.url=${SONAR_HOST_URL} -Dsonar.sourceEncoding=${SOURCE_ENCODING}
  allow_failure: true
  only:
    - 65-ci-sonarqube-sonarqube
    # - develop
